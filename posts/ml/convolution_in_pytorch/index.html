<!DOCTYPE html>
<html >
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="XFeiF">
		<meta name="description" content="XFeiFçš„ç‹¬ç«‹åšå®¢">
		<meta name="generator" content="Hugo 0.53" />
		<title>Convolution&#39;s Numpy and Pytorch implementation &middot; </title>
		<link rel="shortcut icon" href="https://blog.x-fei.me/images/favicon.ico">
		<link rel="stylesheet" href="https://blog.x-fei.me/css/style.css">
		
		
		
		

		

		
		<link href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<link href="https://cdn.staticfile.org/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<script src="https://cdn.staticfile.org/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript" async src="https://cdn.staticfile.org/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$'],
                ['\[\[', '\]\]']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });

    MathJax.Hub.Queue(function() {
        
        
        
        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
    MathJax.Hub.Config({
        CommonHTML: {
            linebreaks: {
                automatic: true
            }
        },
        "HTML-CSS": {
            linebreaks: {
                automatic: true
            }
        },
        SVG: {
            linebreaks: {
                automatic: true
            }
        }
    });
</script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>


<script src="https://cdn.staticfile.org/jquery/1.8.3/jquery.js"></script>
<script src="https://cdn.staticfile.org/jquery.imagesloaded/2.1.0/jquery.imagesloaded.js"></script>
<script src="https://cdn.staticfile.org/masonry/4.2.2/masonry.pkgd.min.js"></script>
<script src="https://cdn.staticfile.org/bigfoot/2.1.4/bigfoot.min.js"></script>
<link href="https://cdn.staticfile.org/bigfoot/2.1.4/bigfoot-default.min.css" rel="stylesheet">

	</head>


<body>
    <div class="nav-header nav-header-fixed animated">
    <a href="https://blog.x-fei.me/" class="left swing">
        <img src="https://blog.x-fei.me/images/Feiaaa.png" alt="" class="icon rounded">
    </a>
</div>

 
<header id="header" class="blog-background banner-mask lazy no-cover" style="display: table; background-image: url(https://raw.githubusercontent.com/XFeiF/Photos/master/blog/PyTorchConv.jpg);">
    <div class="header-wrap site-nav">
    <div class="home-info-container">
        <a href="https://blog.x-fei.me/">
            <h2>Ferry dimmed in moonlight</h2>
        </a>
    </div>
    <div class="nav-header-container">
        <ul class="links">
            <li class="nav-blog">
                <a href='https://blog.x-fei.me/'> Home</a>
            </li>
            <li>
                <a href='https://blog.x-fei.me/archives'>Archives</a>
            </li>
            <li>
                <a href='https://blog.x-fei.me/timelines'>Timelines</a>
            </li>
            <li>
                <a href='https://blog.x-fei.me/friends'>Friends</a>
            </li>
            <li>
                <a href='https://blog.x-fei.me/about'>About</a>
            </li>
        </ul>


    	

    	
    </div>
</div>

</header>
 
    <div id="main">
        <article class="page-template page-index container-wrapper">
            <div class="post-card">
                <div class="post-container">
                    <div class="post-header">
                        <div class="meta">
                            <h1 id="post-title">Convolution&#39;s Numpy and Pytorch implementation</h1>
                            
                            
                                <time datetime="2019-03-03">Mar 3, 2019</time>
                            
                            <span class="categories">
                                 on 
    
        <a class="badge badge-primary" href="/categories/machine-learning">Machine Learning</a>
    


                            </span> - 4 min read.

                        </div>
                    </div>
                    <div class="post-content">
                        <div id="toc" class="">

                        </div>
                        <div class="inner-content">
                            <p>åˆå­¦CNNçš„æ—¶å€™ï¼Œæ¯”è¾ƒç–‘æƒ‘è¾“å…¥çš„ç»´åº¦æ˜¯<code>(BatchSize, Channels, Height, Width)</code>çš„<code>feature map</code>ç»è¿‡sizeæ˜¯kçš„å·ç§¯æ ¸åå˜æˆäº†è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠå®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</p>

<p>æœ¬æ–‡ä¸»è¦è®²è§£å¹¶æ¢ç©¶å·ç§¯å®ç°ã€‚<br />
é¦–å…ˆç®€å•èŠä¸€ä¸‹å·ç§¯æ“ä½œï¼Œä»‹ç»<code>Pytorch</code>ä¸­å·ç§¯çš„<code>API</code>ï¼›<br />
æ¥ç€æˆ‘ä»¬è‡ªå·±ç”¨<code>python</code>å®ç°ç®€å•å·ç§¯ï¼Œå¹¶ä¸<code>API</code>è°ƒç”¨ç»“æœè¿›è¡Œå¯¹æ¯”ï¼›<br />
ä¹‹åæˆ‘ä»¬è¿›ä¸€æ­¥å»äº†è§£<code>Pytorch</code>ä¸­å·ç§¯çš„å®ç°æºç ã€‚<br />
ã€Œæ›´æ–°ã€ï¼Œ<code>element-width</code>å·ç§¯çš„å®ç°ã€‚</p>

<h3 id="brief-introduction">Brief Introduction</h3>

<p>å·ç§¯æ˜¯å½“ä¸‹æµè¡Œçš„è®¡ç®—æœºè§†è§‰æ¨¡å‹æ¶æ„çš„æœ€åŸºç¡€çš„æ„é€ å•å…ƒï¼Œä»åˆ†ç±»æ¨¡å‹ï¼ˆå¦‚ResNetï¼‰åˆ°å¯¹æŠ—ç”Ÿæˆç½‘ç»œï¼ˆå¦‚DC-GANï¼‰ï¼Œå†åˆ°ç›®æ ‡æ£€æµ‹æ¶æ„ï¼ˆä»¥Mask R-CNNä¸ºä»£è¡¨ï¼‰ä»¥åŠå…¶ä»–çš„å¤§å¤§å°å°çš„æ¨¡å‹ï¼Œå·ç§¯æ“ä½œå¯ä»¥å®Œæˆå¤§éƒ¨åˆ†è®¡ç®—ç¹ççš„å·¥ä½œã€‚</p>

<p>å¯¹ä¸å·ç§¯çš„ç†è§£ä¸è§£é‡Šæœ‰å¾ˆå¤šå·²æœ‰çš„ä¼˜ç§€åšæ–‡ï¼Œé™„ä¸Š<strong>ä¼ é€é—¨</strong>ï¼Œæœ¬æ–‡ä¸å¤šè¿½è¿°ã€‚<br />
- <a href="https://www.wikiwand.com/en/Convolution">Wiki</a><br />
- <a href="https://zhuanlan.zhihu.com/p/30994790">ä»€ä¹ˆæ˜¯å·ç§¯</a><br />
- <a href="http://cs231n.github.io/convolutional-networks/#conv">CS231n</a></p>

<p>å·ç§¯è¿ç®—è¡¨é¢ä¸Šçœ‹å°±æ˜¯ï¼Œ<strong>åœ¨æ»¤æ³¢å™¨å’Œè¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸé—´åšç‚¹ç§¯</strong>ï¼Œä¸‹é¢çš„GIFç”¨æ»‘çª—çš„æ–¹å¼è¡¨æ˜äº†å…¶æ˜¯å¦‚ä½•æ“ä½œçš„<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a> </sup>ã€‚
<div align=center>
<img src="https://mlnotebook.github.io/img/CNN/convSobel.gif" width="40%" alt="https://mlnotebook.github.io/post/CNN1/" style="text-align:center; padding:5px auto;">
<img src="https://raw.githubusercontent.com/XFeiF/Photos/master/blog/cal_conv.jpg" width="80%"/>
</div></p>

<h3 id="params">Params</h3>

<p>CNNä¸­å½“å·ç§¯æ ¸sizeç¡®å®šä¹‹åï¼Œæ§åˆ¶è¾“å‡º<code>feature_maps</code>çš„<code>shape</code>çš„æœ‰ä¸‰ä¸ªè¶…å‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>depth</code>ï¼Œ<code>stide</code>ï¼Œ<code>zero-padding</code>:<br />
1. è¾“å‡º<code>feature_maps</code>çš„<code>depth</code>: å®ƒå¯¹åº”æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„å·ç§¯æ ¸çš„æ•°é‡ï¼Œæ¯ä¸ªå·ç§¯æ ¸éƒ½åœ¨è¾“å…¥ä¸­å­¦ä¹ å¯»æ‰¾ä¸åŒçš„ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¬¬ä¸€å·ç§¯å±‚å°†åŸå§‹å›¾åƒä½œä¸ºè¾“å…¥ï¼Œåˆ™æ²¿ç€æ·±åº¦ç»´åº¦çš„ä¸åŒç¥ç»å…ƒå¯ä»¥åœ¨å­˜åœ¨å„ç§å®šå‘è¾¹ç¼˜æˆ–é¢œè‰²ã€æ–‘ç‚¹çš„æƒ…å†µä¸‹æ¿€æ´»ã€‚<br />
2. æ»‘åŠ¨å·ç§¯æ ¸çš„æ­¥å¹…<code>stride</code>: å½“<code>stride=1</code>æ—¶ï¼Œæ¯æ¬¡ç§»åŠ¨å·ç§¯æ ¸ä¸€ä¸ªåƒç´ ï¼›å½“<code>stride=2</code>æ—¶ï¼Œä¸€æ¬¡è·³è·ƒ2ä¸ªåƒç´ ï¼ˆå®è·µä¸­å¾ˆå°‘ç”¨<code>stride&gt;=3</code>ï¼Œä¼šä¸¢å¤±ä¿¡æ¯ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´è¾“å‡ºçš„sizeå˜å°ã€‚<br />
3. <code>zero-padding</code>ï¼šæœ‰æ—¶åœ¨è¾¹ç•Œå‘¨å›´ç”¨é›¶å¡«å……ä¼šå¾ˆæ–¹ä¾¿ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ§åˆ¶è¾“å‡º<code>feature_map</code>çš„ç©ºé—´å¤§å°ï¼Œæœ€å¸¸è§çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒè¾“å‡ºå’Œè¾“å…¥çš„å¤§å°ä¸€æ ·ã€‚å°±åƒä¸Šé¢ç¬¬äºŒå¼ å›¾ä¸­çš„é‚£æ ·ï¼Œåœ¨è¾“å…¥çš„<code>feature_map</code>å››å‘¨è¡¥ä¸Š0ã€‚é€šå¸¸ï¼Œå½“æ­¥å¹…<code>stride=1</code>æ—¶ï¼Œå°†é›¶å¡«å……è®¾ç½®ä¸º<code>P = (F-1)/2</code>ï¼Œä¾‹å¦‚<code>(F,P)=(3,1),(5,2),(7,3)</code>ã€‚</p>

<h3 id="pytorch-api">Pytorch API</h3>

<p>è¿™é‡Œä»¥<a href="https://pytorch.org/docs/stable/nn.html#conv2d"><code>torch.nn.Conv2d</code></a>ä¸ºä¾‹ã€‚</p>

<pre><code class="language-python">class torch.nn.Conv2d(in_channels, out_channels, kernel_size, stride=1, padding=0, dilation=1, groups=1, bias=True)
</code></pre>

<p>å½“è¾“å…¥æ˜¯$(N, C_{in}, H, W)$æ—¶ï¼Œè¾“å‡º$(N, C_{out}, H_{out}, W_{out})$å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—å¾—åˆ°ã€‚
<img src="https://raw.githubusercontent.com/XFeiF/Photos/master/blog/conv_opt.jpg" alt="Conv_Opt" /><br />
å…¶ä¸­ â˜… è¡¨ç¤ºç›¸å…³å·ç§¯æ“ä½œï¼Œ$N$è¡¨ç¤º batch size, $C$ è¡¨ç¤ºchannelsï¼ˆé€šé“ï¼‰æ•°é‡ï¼Œå³<code>feature_map</code> çš„æ•°é‡ï¼Œ$H, W$è¡¨ç¤º<code>feature_map</code>çš„åƒç´ é«˜åº¦å’Œå®½åº¦ã€‚</p>

<p>åœ¨ç†è§£äº†ä¸Šå°èŠ‚çš„Paramsåï¼Œæˆ‘ä»¬å°±ä¸éš¾ç†è§£APIä¸­å‚æ•°çš„å«ä¹‰äº†ã€‚è¿™ç¯‡<a href="https://www.aiuai.cn/aifarm618.html">æ–‡ç« </a>å°†APIè§£è¯»å¾—å¾ˆè¯¦ç»†ï¼ˆå°¤å…¶æ˜¯å¯¹<code>group</code>å‚æ•°çš„è§£é‡Šï¼‰ã€‚</p>

<p>å€¼å¾—ä¸€æçš„æ˜¯APIä¸­<code>kernel_size</code>,<code>stride</code>,<code>padding</code>å‚æ•°æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªå•ä¸€çš„æ•´æ•°ï¼ˆè¡¨ç¤ºæ¨ªè¡Œå’Œçºµå‘ç§»åŠ¨ç›¸åŒçš„å•ä½é•¿åº¦ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±ä¸¤ä¸ªæ•´æ•°æ„æˆçš„<code>tuple</code>å¯¹è±¡ã€‚å¦‚æœæ˜¯ä¸¤ä¸ªæ•´æ•°ï¼Œé‚£ä¹ˆè¿ç®—çš„æ—¶å€™ï¼Œæ¨ªå‘æ­¥é•¿ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯çºµå‘æ­¥é•¿ã€‚</p>

<p>ç°åœ¨å›åˆ°æ–‡ç« æœ€å¼€å¤´æçš„é—®é¢˜ï¼Œè¾“å…¥çš„å½¢çŠ¶æ˜¯$(N, C_{in}, H, W)$ï¼Œè¾“å‡ºçš„å½¢çŠ¶æ˜¯$(N, C_{out}, H_{out}, W_{out})$ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”±<code>kernel_size</code>,<code>stride</code>,<code>padding</code>è¡¨è¾¾ã€‚å‡è®¾æˆ‘ä»¬ä¸è€ƒè™‘<code>PyTorch</code>æ–‡æ¡£ä¸­çš„<code>dilation</code>å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„å…³ç³»å¼ï¼š<br />
$$ H_{out} = [\frac{H_{in} + 2 \times padding[0] - (\text{kernel_size}[0] - 1) - 1}{stride[0]} + 1] $$
$$ W_{out} = [\frac{W_{in} + 2 \times padding[1] - (\text{kernel_size}[1] - 1) - 1}{stride[1]} + 1] $$<br />
çœ‹åˆ°è¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬å°±ä¸éš¾ç†è§£ä¸Šé¢çš„å¦‚ä½•ä¿æŒ$H_{out},H_{in}$å°ºå¯¸ç›¸åŒäº†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®<code>stride=1</code>ï¼Œé‚£ä¹ˆå°±æœ‰ï¼š<br />
$$ 2 \times padding[0] = \text{kernel_size}[0] - 1 $$
æ‰€ä»¥ï¼Œä»¥åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå…¬å¼çµæ´»å¾—åˆ°ä¸<code>kernel_size</code>å¯¹åº”çš„<code>padding</code>äº†ã€‚å¸¸ç”¨çš„ç»„åˆæœ‰$(k,p) = (3, 1), (5, 2), (7, 3)$ã€‚</p>

<h3 id="numpy-implementation">Numpy Implementation</h3>

<p>æœ¬å°ç»“ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨<code>Numpy</code>æ¥å®ç°å·ç§¯è¿ç®—ï¼Œå®ç°ä¸Šé¢å›¾ä¸­çš„è¿ç®—ï¼Œå¹¶å°†ç»“æœå’Œè°ƒç”¨<code>PyTorch</code>çš„<code>API</code>çš„ç»“æœè¿›è¡Œå¯¹æ¯”éªŒè¯ã€‚</p>

<h4 id="simple-convolution">Simple Convolution</h4>

<p>é¦–å…ˆï¼Œå®ç°ä¸€ä¸ªæœ€åŸºæœ¬çš„å·ç§¯è¿‡ç¨‹ï¼Œè¿™ä¸ªå·ç§¯è¿ç®—æ˜¯å•é€šé“è¾“å…¥ã€å•é€šé“è¾“å‡ºçš„ï¼Œç”¨ä½œå·ç§¯çš„æœ€åŸºç¡€çš„è¿ç®—æ¨¡å—ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾å®š<code>stride=1</code>ã€‚</p>

<pre><code class="language-python">import numpy as np
def baseConv(feature_map, kernel):
    '''
    Args:
        feature_map: [H, W]
        kernel: [k, k]
    Returns:
        out: [H, W]
    '''
    h, w = feature_map.shape
    k, _ = kernel.shape
    # padding
    p = int(k / 2)
    # add zeors padding
    feature_map_padding = np.zeros([h + p * 2, w + p * 2])
    feature_map_padding[p:h + p, p:w + p] = feature_map

    result = np.zeros([h, w])
    for i in range(h):
        for j in range(w):
            # region of interest
            roi = feature_map_padding[i:i + k, j:j + k]
            result[i][j] = np.sum(roi * kernel)
    return result
</code></pre>

<h4 id="conv2d">Conv2d</h4>

<p>ä»¥ä¸Šåªæ˜¯æœ€ç®€å•ç‰ˆæœ¬çš„å•é€šé“è¾“å…¥ã€å•é€šé“è¾“å‡ºçš„å·ç§¯è¿‡ç¨‹ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬åœ¨å®é™…è¿ç®—çš„è¿‡ç¨‹ä¸­ç”¨åˆ°çš„éƒ½æ˜¯å¤šé€šé“è¾“å…¥ã€å¤šé€šé“è¾“å…¥çš„å·ç§¯ã€‚åœ¨ä¸Šè¿°æ¨¡å—çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°å¤šé€šé“è¾“å…¥å¤šé€šé“è¾“å…¥çš„å·ç§¯è¿ç®—è¿‡ç¨‹ã€‚åªéœ€è¦ä½¿ç”¨ä¸¤ä¸ªforå¾ªç¯ï¼Œéå†æ¯ä¸€ä¸ªé€šé“çš„è¾“å…¥å’Œæ¯ä¸€ä¸ªé€šé“çš„è¾“å‡ºå³å¯ã€‚å¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<pre><code class="language-python">def conv2d(input, weights):
    '''
    Args:
        input: [C_in, H, W]
        weights: [C_out, K, K]
    Returns:
        out: [C_out, H, W]
    '''
    in_channel, h, w = input.shape
    out_channel, *_  = weights.shape
    
    output = np.zeros( [out_channel, h, w] )
    for i in range(out_channel):
        weight = weights[i]
        for j in range(in_channel):
            feature_map = input[j]
            kernel      = weight[j]
            output[i]  += baseConv(feature_map, kernel)
    return output
</code></pre>

<h4 id="test">Test</h4>

<p>å†™å¥½å‡½æ•°åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸Šé¢å›¾ç‰‡é‡Œçš„æ•°æ®æ¥éªŒè¯ä¸€ä¸‹ç¨‹åºè¿ç®—ç»“æœçš„æ­£ç¡®æ€§ã€‚</p>

<pre><code class="language-python">input_data=[   [[1,0,1,2,1],
               [0,2,1,0,1],
               [1,1,0,2,0],
               [2,2,1,1,0],
               [2,0,1,2,0]],
               [[2,0,2,1,1],
                [0,1,0,0,2],
                [1,0,0,2,1],
                [1,1,2,1,0],
                [1,0,1,1,1]],]
weights_data=[[ [[ 1, 0, 1],
                 [-1, 1, 0],
                 [ 0,-1, 0]],
                [[-1, 0, 1],
                 [ 0, 0, 1],
                 [ 1, 1, 1]] 
           ]]
# change list into numpy array
input   = np.array(input_data)
weights = np.array(weights_data)
# show the result
print(conv2d(input, weights))

#[[[ 2.  0.  2.  4.  0.]
#  [ 1.  4.  4.  3.  5.]
#  [ 4.  3.  5.  9. -1.]
#  [ 3.  4.  6.  2.  1.]
#  [ 5.  3.  5.  1. -2.]]]
</code></pre>

<p>ä¸‹é¢æˆ‘ä»¬å†ç”¨<code>Pytorch</code>é‡Œé¢çš„<a href="https://pytorch.org/docs/stable/nn.html#id21"><code>torch.nn.functional.conv2d</code></a>æ¥éªŒè¯ä¸€ä¸‹ã€‚</p>

<pre><code class="language-python">import torch.nn.functional as F
input = torch.tensor(input_data).unsqueeze(0).float()
weights = torch.tensor(weights_data).float()
result = F.conv2d(input, weights, padding=1)
# tensor([[[[ 2.,  0.,  2.,  4.,  0.],
#          [ 1.,  4.,  4.,  3.,  5.],
#          [ 4.,  3.,  5.,  9., -1.],
#          [ 3.,  4.,  6.,  2.,  1.],
#          [ 5.,  3.,  5.,  1., -2.]]]])
</code></pre>

<p>éªŒè¯å®Œæ¯•ã€‚</p>

<h3 id="pytorch-source-code">PyTorch Source Code</h3>

<p>ç°åœ¨æˆ‘ä»¬æ¥è¿½æœ¬æº¯æºï¼Œçœ‹çœ‹<code>PyTorch</code>ä¸­æ˜¯å¦‚ä½•å®ç°<code>conv</code>æ“ä½œçš„ã€‚<br />
å½“æˆ‘ä»¬åœ¨<code>PyCharm</code>ä¸­è¿½ä¹Ÿåªèƒ½çœ‹åˆ°<code>nn.Conv2d</code>è°ƒç”¨äº†<code>nn.functional.conv2d</code>ï¼Œå†å¾€ä¸‹å°±æ²¡æœ‰äº†ã€‚<br />
<a href="https://stackoverflow.com/questions/53927358/pytorch-where-is-conv1d-implemented">Stackoverflow</a>çš„è¿™ä¸ªå›ç­”æé†’äº†æˆ‘ã€‚<br />
<img src="http://ww1.sinaimg.cn/large/005O8ntygy1g0r7izbm4bj30kk074tb0.jpg"/><br />
æˆ‘ä»¬å¦‚æœæ˜¯ä¾èµ–äºGPUï¼Œé‚£ä¹ˆè¦å»<code>cudnn</code>é‡Œæ‰¾ï¼Œä½†æ˜¯<code>cudnn</code>æ˜¯é—­æºçš„ï¼Œçœ‹ä¸åˆ°åº•å±‚çš„å®ç°ã€‚ä½†æ˜¯å¯¹äºCPUç‰ˆæœ¬ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒçš„åº•å±‚è¿˜æ˜¯ç”¨<code>C,C++</code>æ¥å®ç°çš„ï¼Œæ‰€ä»¥ä»è¿™æ–¹é¢ç€æ‰‹ï¼Œæ‰¾äº†<code>Github</code>é‡Œ<code>pytorch.torch.csrc</code>ï¼Œä¾ç„¶æ²¡æœ‰å“¦ã€‚<br />
æ‰€å¹¸çš„æ˜¯ï¼Œæˆ‘æ‰¾åˆ°äº†è¿™ä¸ª<a href="https://github.com/pytorch/pytorch/tree/master/aten/src"><code>aten</code></a>ã€‚<code>src</code>é‡Œçš„è¯´æ˜æ–‡ä»¶è¡¨æ˜è¿™æ˜¯<code>PyTorch</code>çš„åº•å±‚<code>tensor</code>åº“ã€‚æˆ‘ä»¬è¦æ‰¾CPUç‰ˆæœ¬çš„ï¼Œæ‰€ä»¥ç›´æ¥åœ¨<code>TH=TorcH</code>é‡Œå¯»æ‰¾ï¼Œç»ˆäºæ‰¾åˆ°äº†<a href="https://github.com/pytorch/pytorch/blob/master/aten/src/TH/generic/THTensorConv.cpp">è¿™ä»½å®ç°</a>ã€‚æˆ‘ä»¬æˆªå–éƒ¨åˆ†ä»£ç åˆ†æä¸€ä¸‹ï¼š</p>

<pre><code class="language-cpp">/*
  2D Input, 2D kernel  : convolve given image with the given kernel.
*/
void THTensor_(validXCorr2Dptr)(scalar_t *r_,
                                       scalar_t alpha,
                                       scalar_t *t_, int64_t ir, int64_t ic,
                                       scalar_t *k_, int64_t kr, int64_t kc,
                                       int64_t sr, int64_t sc)
{
  int64_t or_ = (ir - kr) / sr + 1;
  int64_t oc = (ic - kc) / sc + 1;

  int64_t xx, yy, kx, ky;

  if ((sc != 1) || (oc &lt; 4))  {
    /* regular convolution */
    for(yy = 0; yy &lt; or_; yy++) {
      for(xx = 0; xx &lt; oc; xx++) {
        /* Dot product in two dimensions... (between input image and the mask) */
        scalar_t *pi_ = t_ + yy*sr*ic + xx*sc;
        scalar_t *pw_ = k_;
        scalar_t sum = 0;
        for(ky = 0; ky &lt; kr; ky++) {
          for(kx = 0; kx &lt; kc; kx++) {
            sum += pi_[kx]*pw_[kx];
          }
          pi_ += ic; /* next input line */
          pw_ += kc; /* next mask line */
        }
        /* Update output */
        *r_++ += alpha*sum;
      }
    }

  } else {
    /* SSE-based convolution */
    ...
  }
}
</code></pre>

<p>é¦–å…ˆå®ƒçš„æ•°æ®ç±»å‹ï¼Œéƒ½æ˜¯åœ¨<code>C++</code>æ•°æ®ç±»å‹åé¢åŠ äº†<code>_t</code>ï¼Œåº”è¯¥æ˜¯è¡¨ç¤ºè¿™ä¸ª<code>Tensor</code>ç±»å‹åŸºæœ¬ç±»å‹ã€‚<br />
æ¥ç€æ˜¯ä»–çš„å‚æ•°ï¼Œ<code>ir, ic</code>è¡¨ç¤ºè¾“å…¥çš„<code>row</code>å’Œ<code>col</code>ï¼ŒåŒç†<code>kr, kc</code>ï¼Œ<code>sr, sc</code>åˆ†åˆ«è¡¨ç¤º<code>kernel</code>å’Œ<code>stride</code>çš„åƒç´ é•¿åº¦ã€‚<br />
å‡½æ•°ä½“å‰ä¸¤è¡Œå…ˆå®šä¹‰äº†è¾“å‡ºçš„<code>row</code>å’Œ<code>col</code>ï¼›æ¥ä¸‹æ¥å¯¹<code>sc</code>å’Œ<code>oc</code>çš„åˆ¤æ–­æ˜¯ä¸ºäº†ä½¿ç”¨<a href="https://www.wikiwand.com/en/Streaming_SIMD_Extensions"><code>SSE-based convolution</code></a>ï¼Œæˆ‘ä»¬é€‰æ‹©å¿½ç•¥ï¼Œç›´æ¥çœ‹<code>if</code>çš„ä»£ç å—å†…å®¹ï¼Œå‘ç°å¤–å±‚ä¸¤ä¸ªå¾ªç¯å’Œæˆ‘ä»¬ä¸Šé¢å®ç°çš„<code>baseConv</code>é‡Œçš„å¾ªç¯<code>h,w</code>ä¸€æ ·ï¼Œä¸ºäº†è®¡ç®—è¾“å‡ºçš„æ¯ä¸ªåƒç´ ç‚¹çš„æœ€ç»ˆå€¼ï¼›è€Œå†…å±‚çš„ä¸¤ä¸ªå¾ªç¯åˆ™æ˜¯åšå·ç§¯æ“ä½œå¾—åˆ°æ–°çš„åƒç´ å€¼ï¼Œæˆ‘ä»¬åˆ™æ˜¯åˆ©ç”¨äº†<code>numpy</code>çš„è®¡ç®—ä¾¿åˆ©æ€§ï¼›<code>*r_++ += alpha*sum</code>å·¦è¾¹<code>*r</code>è¡¨ç¤ºçš„æ˜¯è¿”å›æ•°æ®çš„å¼•ç”¨ï¼Œé€šè¿‡è‡ªå¢æ”¹å˜å¯¹åº”åœ°å€çš„å…ƒç´ ï¼Œå³è¾¹çš„<code>alpha</code>åº”è¯¥æ˜¯å·ç§¯çš„æƒé‡ã€‚</p>

<h3 id="element-width-convolution">Element Width Convolution</h3>

<p>ã€2019å¹´3æœˆ12æ—¥æ›´æ–°ã€‘<br />
ä¸Šé¢çš„è®¨è®ºä¸­ä¸€ç›´å¿½ç•¥äº†<code>groups</code>è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°çš„åŠŸèƒ½è¿˜æ˜¯ç›¸å½“å¼ºå¤§çš„ã€‚<br />
ç›®å‰æˆ‘ä»¬äº†è§£åˆ°çš„å·ç§¯éƒ½æ˜¯<code>cross-related</code>çš„ï¼Œå°±æ˜¯è¯´ä¸‹ä¸€å±‚çš„æ¯ä¸ªç¥ç»å…ƒéƒ½æœ‰å‰ä¸€å±‚æ‰€æœ‰ç¥ç»å…ƒçš„è´¡çŒ®ï¼Œè´¡çŒ®å¤šå°‘å°±æ˜¯éœ€è¦å­¦ä¹ çš„æƒå€¼ã€‚<br />
ç°åœ¨æœ‰ä¸¤ç§æƒ…å†µï¼š<br />
- 1 å‡è®¾æœ‰äº›ç¥ç»å…ƒæ— å…³ï¼Œä¸‹ä¸€å±‚ä¸æƒ³è¦å®ƒè´¡çŒ®ï¼Œå³ä½¿å¯ä»¥è®¾ç½®å…¶æƒå€¼ä¸º0ï¼Œä½†æ˜¯æ— æ³•å•ä¸ªå†»ç»“ã€‚<br />
- 2 å‡è®¾æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ªæ“ä½œï¼Œå®ƒå®ç°çš„æ˜¯å¯¹ä¸Šä¸€å±‚ï¼ˆ<code>[B,C,H,W]</code>ï¼‰æ¯ä¸ª<code>feature map</code>ï¼ˆå³Cä¸ªï¼‰ï¼Œéƒ½åˆ†åˆ«åšæ“ä½œï¼Œåšå®Œä¹‹åå†ä¼ åˆ°ä¸‹ä¸€å±‚ã€‚å½“ç„¶è¿™ä¸ªæ“ä½œæ˜¯ä¸å½±å“åå‘ä¼ æ’­çš„ã€‚<br />
ç±»ä¼¼è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨<code>groups</code>å‚æ•°ã€‚å®ƒæ§åˆ¶ç€è¾“å…¥å’Œè¾“å‡ºä¹‹å‰çš„è¿æ¥ï¼Œéšå«æ¡ä»¶æ˜¯è¾“å…¥å’Œè¾“å‡ºçš„é€šé“æ•°é‡è¦èƒ½è¢«<code>groups</code>æ•´é™¤ã€‚<br />
- å½“<code>groups=1</code>æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½ç»è¿‡å·ç§¯åˆ°è¾“å‡ºã€‚<br />
- å½“<code>groups=2</code>æ—¶ï¼Œè¯¥æ“ä½œå˜å¾—ç­‰åŒäºå¹¶æ’å…·æœ‰ä¸¤ä¸ªå·ç§¯å±‚ï¼Œæ¯ä¸ªå·ç§¯è¾“å…¥é€šé“çš„ä¸€åŠï¼Œå¹¶ä¸”äº§ç”Ÿè¾“å‡ºé€šé“çš„ä¸€åŠï¼Œå¹¶ä¸”éšåè¿æ¥ã€‚
- å½“<code>groups=in_channels</code>æ—¶ï¼Œæ¯ä¸ªè¾“å…¥åªå’Œå®ƒå¯¹åº”çš„ä¸€ç»„å·ç§¯ï¼ˆå…± $\frac{C_{out}}{C_{in}}$ ä¸ªï¼‰è¿›è¡Œå·ç§¯ã€‚</p>

<h3 id="summary">Summary</h3>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„å®ç°å’Œ<code>PyTorch</code>çš„åº•å±‚å®ç°å…¶å®æ˜¯ç›¸åŒçš„ã€‚<br />
æ„Ÿè°¢å´”å“¥æä¾›çš„æ”¯æŒã€‚</p>

<p><br></p>

<div class="footnotes"><ol>  
    <li class="footnote" id="fn:1">
        <p>å¤šç§å·ç§¯åŠ¨å›¾è¯·è§--> <a href="https://github.com/vdumoulin/conv_arithmetic" target="_blank">Github</a><a href="#fnref:1" title="answer"> </a><p>
    </li>
</ol></div>

<script type="text/javascript">
    $.bigfoot();
</script>
<script type="text/javascript">
    var bigfoot = $.bigfoot({
        deleteOnUnhover: false,
        preventPageScroll: false,
        hoverDelay: 250,
    });
</script>
                        </div>
                    </div>
                    
                    <div class="post-tags">
                        <span># Tags: </span>
                            
                                <a class="badge badge-primary" href="/tags/python">python</a>
                            
                                <a class="badge badge-primary" href="/tags/pytorch">pytorch</a>
                            
                                <a class="badge badge-primary" href="/tags/code">code</a>
                            
                    </div>
                    
                    <nav class="post-related">
                            

    <a rel="prev" id="prev-btn" class="btn hvr-grow" href="/posts/paper/resnet/"> &laquo; Paper Notes[2]: ResNet</a>


    <a rel="next" id="next-btn" class="btn hvr-grow" href="/posts/lambda_function_in_python/">Lambda Function in Python &raquo;</a>


                    </nav>
                    <footer class="comments">
                        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "xfeif" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    </footer>
                </div>
            </div>

        </article>
    </div>
    <a id="rocket" href="#top" class=""></a>
<script type="text/javascript" src="https://blog.x-fei.me/js/totop.js"></script>
<footer id="footer" class='site-footer'>
    
    <section class="footer">
    
       ğŸ“<a href="https://blog.x-fei.me">XFeiF</a> Â© 2015-2019 <i class="fa fa-heart" aria-hidden="true"></i>
    
    </section>
    <section>
        Theme Fx <a href="https://github.com/XFeiF" class="github-repo"><span class="gadget-github"></span>Star</a>
        Designed By <a href="https://github.com/XFeiF">@XFeiF</a>
    </section>
    <section class="poweredby">
        Powered by <a href="http://www.gohugo.io/">Hugo</a>
    </section>
</footer>

</body>
</html>
